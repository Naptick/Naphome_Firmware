# Certificate Loading Diagnostics

## Overview
The `somnus_mqtt` service attempts to load AWS IoT certificates from the SPIFFS filesystem. If the filesystem is not mounted or certificates are not present, it falls back to embedded PEM certificates compiled into the firmware.

## Certificate Discovery Process

1. **Directory Check**: Verifies that `/spiffs/Cert` (or `CONFIG_SOMNUS_MQTT_CERT_DIR`) exists and is accessible
2. **File Discovery**: Scans for:
   - `*-certificate.pem.crt` (device certificate)
   - `*-private.pem.key` (device private key)
   - `AmazonRootCA1.pem` or files containing "CA1.pem" (root CA)
3. **File Loading**: Reads and validates each certificate file
4. **Fallback**: If any step fails, uses embedded certificates from build-time binary assets

## Enhanced Error Messages

The improved diagnostics now provide:

- **Directory Access Errors**: Shows errno and strerror for filesystem issues
- **File Access Errors**: Validates file existence and readability before opening
- **Missing Files**: Lists which certificate files were found/missing
- **Clear Fallback Messages**: Explains when and why embedded certificates are used

## Common Issues

### SPIFFS Not Mounted
**Symptom**: `Certificate directory does not exist or is not accessible: /spiffs/Cert (errno: 2)`

**Solution**: Ensure SPIFFS is mounted before `somnus_mqtt_start()` is called. Check that:
- SPIFFS partition is configured in partition table
- `esp_vfs_spiffs_register()` is called during initialization
- Mount point matches `CONFIG_SOMNUS_MQTT_CERT_DIR`

### Certificates Not Provisioned
**Symptom**: `Incomplete certificate set in /spiffs/Cert`

**Solution**: Provision certificates using:
```bash
python scripts/provision_and_stage_somnus_cert.py --thing-name SOMNUS_<DEVICE>
```

This script:
- Creates AWS IoT Thing and certificates
- Copies certificates to `samples/korvo_voice_assistant/spiffs/Cert/`
- Updates SPIFFS image for next flash

### Filesystem Permissions
**Symptom**: `Failed to open cert directory: /spiffs/Cert (errno: 13, Permission denied)`

**Solution**: Check SPIFFS mount configuration and ensure proper permissions are set.

## Log Messages

### Success
```
I (1234) somnus_mqtt: Scanning certificate directory: /spiffs/Cert
I (1235) somnus_mqtt: Loading certificate file: /spiffs/Cert/device-certificate.pem.crt
I (1236) somnus_mqtt: Successfully loaded certificates from filesystem
```

### Fallback to Embedded
```
W (1234) somnus_mqtt: Certificate directory does not exist or is not accessible: /spiffs/Cert (errno: 2)
I (1235) somnus_mqtt: This is expected if SPIFFS is not mounted or certificates are not provisioned
I (1236) somnus_mqtt: Falling back to embedded PEM certificates
I (1237) somnus_mqtt: Using embedded certificates from build-time binary assets
```

## Configuration

- `CONFIG_SOMNUS_MQTT_CERT_DISCOVERY`: Enable/disable filesystem certificate discovery
- `CONFIG_SOMNUS_MQTT_CERT_DIR`: Directory path to scan (default: `/spiffs/Cert`)

## Embedded Certificates

If filesystem discovery fails, the service uses certificates embedded at build time:
- `_binary_root_ca_pem_start/end`
- `_binary_device_cert_pem_start/end`
- `_binary_private_key_pem_start/end`

These are compiled from files in `components/aws_iot/certs/` or generated by the provisioning script.
